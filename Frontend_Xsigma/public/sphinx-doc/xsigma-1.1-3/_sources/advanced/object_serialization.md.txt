# Auto serialization
Modules which have `INCLUDE_MARSHAL` in their `xsigma.module` will opt their headers into the automated code generation of (de)serializers. Only classes which are annotated by the `XSIGMA_MARSHALAUTO` wrapping hint will have generated serialization code.

## Automated code generation
The `xsigmaWrapSerDes` executable makes use of the `WrappingTools` package to automatically generate
1. A serializer function with signature
  `nlohmann:json Serialize_xsigmaClassName(xsigmaObjectBase*, xsigmaSerializer*)`
2. A deserializer function with signature
  `void(const nlohmann::json&, xsigmaObjectBase*, xsigmaDeserializer*)`
3. A registrar function that registers
    - the serializer function with a serializer instance
    - the deserializer function with a deserializer instance
    - the constructor of the XSIGMA class with a deserializer instance
    - It's signature is
      `int RegisterHandlers_xsigmaClassNameSerDes(void* ser, void* deser)`
    - It more or less looks like:
      ```c++
      int RegisterHandlers_xsigmaObjectSerDes(void* ser, void* deser)
      {
        int success = 0;
        if (auto* asObjectBase = static_cast<xsigmaObjectBase*>(ser))
        {
          if (auto* serializer = xsigmaSerializer::SafeDownCast(asObjectBase))
          {
            serializer->RegisterHandler(typeid(xsigmaObject), Serialize_xsigmaObject);
            success = 1;
          }
        }
        if (auto* asObjectBase = static_cast<xsigmaObjectBase*>(deser))
        {
          if (auto* deserializer = xsigmaDeserializer::SafeDownCast(asObjectBase))
          {
            deserializer->RegisterHandler(typeid(xsigmaObject), Deserialize_xsigmaObject);
            deserializer->RegisterConstructor("xsigmaObject", []() { return xsigmaObject::New(); });
            success = 1;
          }
        }
        return success;
      }
      ```

## Marshal hint macro
  1. Classes which are annotated with `XSIGMA_MARSHALAUTO` are considered by the `xsigmaWrapSerDes` executable.
  2. Classes annotated with `XSIGMA_MARSHALMANUAL` are hand coded in the same module. Here are some examples:
     - `Common/Core/xsigmaCollectionSerDesHelper.cxx` for `Common/Core/xsigmaCollection.h`
     - `Common/DataModel/xsigmaCellArraySerDesHelper.cxx` for `Common/DataModel/xsigmaCellArray.h`

## Convenient script to annotate headers and module
- The [Utilities/Marshalling/marshal_macro_annotate_headers.py](../../../Utilities/Marshalling/marshal_macro_annotate_headers.py) script annotates headers for automatic or manual serialization. It is fed and driven by the accompanying [Utilities/Marshalling/XSIGMA_MARSHALAUTO.txt](../../../Utilities/Marshalling/XSIGMA_MARSHALAUTO.txt), [Utilities/Marshalling/XSIGMA_MARSHALMANUAL.txt](../../../Utilities/Marshalling/XSIGMA_MARSHALMANUAL.txt) and [Utilities/Marshalling/ignore.txt](../../../Utilities/Marshalling/ignore.txt).

- When the `-u, --update` argument is used, headers are in-place edited to use the `XSIGMA_MARSHAL(AUTO|MANUAL)` wrapping hint. Files that already have this hint are untouched.

- When the `-t, --test` argument is used, the source tree is checked for inconsistent use of marshal macros.
